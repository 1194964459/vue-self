# å¿«é€ŸDiffç®—æ³•

Vue.js 2 æ‰€é‡‡ç”¨çš„åŒç«¯Diff ç®—æ³•ã€‚

å¿«é€Ÿ Diff ç®—æ³•æ˜¯å¦‚æ­¤é«˜æ•ˆçš„ã€‚

## ä¸€ã€ç›¸åŒçš„å‰ç½®å…ƒç´ å’Œåç½®å…ƒç´ 
å¿«é€Ÿ Diff ç®—æ³•åŒ…å«**é¢„å¤„ç†æ­¥éª¤**ï¼Œè¿™å…¶å®æ˜¯å€Ÿé‰´äº†çº¯æ–‡æœ¬ Diff ç®—æ³•çš„æ€è·¯ã€‚
1. **å…¨ç­‰æ¯”è¾ƒ**
```js
if (text1 === text2) return
```
å¦‚æœä¸¤æ®µæ–‡æœ¬å…¨ç­‰ï¼Œé‚£ä¹ˆå°±æ— é¡»è¿›å…¥æ ¸å¿ƒ Diff ç®—æ³•çš„æ­¥éª¤äº†ã€‚

2. **å¤„ç†ä¸¤æ®µæ–‡æœ¬ç›¸åŒçš„å‰ç¼€å’Œåç¼€**ï¼Œå¦‚æ­¤ï¼Œåœ¨ç‰¹å®šæƒ…å†µä¸‹æˆ‘ä»¬èƒ½å¤Ÿè½»æ¾åœ°åˆ¤æ–­æ–‡æœ¬çš„æ’å…¥å’Œåˆ é™¤ã€‚
```js
TEXT1: I like you
TEXT2: I like you too

// ç»é¢„å¤„ç†åï¼Œå»æ‰ç›¸åŒçš„å‰ç¼€ã€åç¼€å
TEXT1:
TEXT2: too
```

### å€Ÿé‰´çº¯æ–‡æœ¬Diffç®—æ³•åçš„DOM Diffç®—æ³•ï¼š

**1. é¢„å¤„ç†ï¼šå¤„ç†ç›¸åŒçš„å‰ç¼€ã€åç¼€**
```js
function patchKeyedChildren(n1, n2, container) {
  const newChildren = n2.children
  const oldChildren = n1.children
  // TODO:æ›´æ–°ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹
  let j = 0
  let oldVNode = oldChildren[j]
  let newVNode = newChildren[j]
  // while å¾ªç¯å‘åéå†ï¼Œç›´åˆ°é‡åˆ°æ‹¥æœ‰ä¸åŒ key å€¼çš„èŠ‚ç‚¹ä¸ºæ­¢
  while (oldVNode.key === newVNode.key) {
    // è°ƒç”¨ patch å‡½æ•°è¿›è¡Œæ›´æ–°
    patch(oldVNode, newVNode, container)
    // æ›´æ–°ç´¢å¼• jï¼Œè®©å…¶é€’å¢
    j++
    oldVNode = oldChildren[j]
    newVNode = newChildren[j]
  }

  // TODO:æ›´æ–°ç›¸åŒçš„åç½®èŠ‚ç‚¹
  // ç´¢å¼• oldEnd æŒ‡å‘æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
  let oldEnd = oldChildren.length -
  // ç´¢å¼• newEnd æŒ‡å‘æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
  let newEnd = newChildren.length - 1
  oldVNode = oldChildren[oldEnd]
  newVNode = newChildren[newEnd]
  // while å¾ªç¯â€œä»åå‘å‰éå†â€ï¼Œç›´åˆ°é‡åˆ°æ‹¥æœ‰ä¸åŒ key å€¼çš„èŠ‚ç‚¹ä¸ºæ­¢
  while (oldVNode.key === newVNode.key) {
    // è°ƒç”¨ patch å‡½æ•°è¿›è¡Œæ›´æ–°
    patch(oldVNode, newVNode, container)
    // é€’å‡ oldEnd å’Œ nextEnd
    oldEnd--
    newEnd--
    oldVNode = oldChildren[oldEnd]
    newVNode = newChildren[newEnd]
  }
}

```
ä½†ä¸Šè¿°çš„æƒ…å†µæ˜¯ç‰¹æ®Šæƒ…å†µï¼Œä¸å¯èƒ½æ–°æ—§èŠ‚ç‚¹çš„éƒ½ä¸€æ ·çš„ï¼Œæœ‰å¯èƒ½å¤šäº†ã€ä¹Ÿæœ‰å¯èƒ½å°‘äº†..

**2.æ–°å¢ã€åˆ é™¤**  

**æ–°å¢ï¼š**   
* æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼šp-1ã€p-2ã€p-3ã€‚
* æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼šp-1ã€p-4ã€p-2ã€p-3ã€‚

**åˆ é™¤ï¼š**
* æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼šp-1ã€p-2ã€p-3ã€‚
* æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼šp-1ã€p-3ã€‚
```js
function patchKeyedChildren(n1, n2, container) {
  const newChildren = n2.children
  const oldChildren = n1.children
  // æ›´æ–°ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹
  // çœç•¥éƒ¨åˆ†ä»£ç 

  // æ›´æ–°ç›¸åŒçš„åç½®èŠ‚ç‚¹
  // çœç•¥éƒ¨åˆ†ä»£ç 
  
  // é¢„å¤„ç†å®Œæ¯•åï¼Œåˆ†åˆ«å¤„ç†æ–°å¢ã€åˆ é™¤
  // æ–°å¢ï¼šåˆ™è¯´æ˜ä» j --> newEnd ä¹‹é—´çš„èŠ‚ç‚¹åº”ä½œä¸ºæ–°èŠ‚ç‚¹æ’å…¥
  if (j > oldEnd && j <= newEnd) {
    // é”šç‚¹çš„ç´¢å¼•
    const anchorIndex = newEnd + 1
    // é”šç‚¹å…ƒç´ ï¼Œç”¨äºç²¾ç¡®æ§åˆ¶æ–°èŠ‚ç‚¹çš„æ’å…¥ä½ç½®ã€‚
    const anchor = anchorIndex < newChildren.length ? newChildren[anchorIndex].el : null
    // é‡‡ç”¨ while å¾ªç¯ï¼Œè°ƒç”¨ patch å‡½æ•°é€ä¸ªæŒ‚è½½æ–°å¢èŠ‚ç‚¹
    while (j <= newEnd) {
      patch(null, newChildren[j++], container, anchor)
    }
  }

   // åˆ é™¤ï¼š
   else if (j > newEnd && j <= oldEnd) {
    // j -> oldEnd ä¹‹é—´çš„èŠ‚ç‚¹åº”è¯¥è¢«å¸è½½
    while (j <= oldEnd) {
      unmount(oldChildren[j++])
    }
  }
}
```

## äºŒã€åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œ DOM ç§»åŠ¨æ“ä½œ
### 1. ä¸¾ä¾‹è¯´æ˜ï¼Œä¸ºä»€ä¹ˆè¦ç§»åŠ¨ï¼Ÿ
æ–°æ—§ä¸¤ç»„å­èŠ‚ç‚¹çš„é¡ºåºå¦‚ä¸‹ï¼š
> æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼šp-1ã€p-2ã€p-3ã€p-4ã€p-6ã€p-5ã€‚   
> æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ï¼šp-1ã€p-3ã€p-4ã€p-2ã€p-7ã€p-5ã€‚
åƒè¿™æ ·çš„æ¡ˆä¾‹ï¼Œæ— æ³•é€šè¿‡ç®€å•çš„é¢„å¤„ç†è¿‡ç¨‹å®Œæˆæ›´æ–°ã€‚

å› æ­¤ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯ï¼Œåˆ¤æ–­å“ªäº›èŠ‚ç‚¹éœ€è¦ç§»åŠ¨ï¼Œä»¥åŠåº”è¯¥å¦‚ä½•ç§»åŠ¨ã€‚

ä¸Šè¿°æ¡ˆä¾‹ï¼Œå½“ç›¸åŒçš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹è¢«å¤„ç†å®Œæ¯•åï¼Œç´¢å¼•jã€newEnd å’Œ oldEnd ä¸æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼š
* j > oldEnd && j <= newEnd
* j > newEnd && j <= oldEnd

å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ æ–°çš„ else åˆ†æ”¯æ¥å¤„ç†å›¾ 11-17 æ‰€ç¤º

### 2. ç‰¹æ®Šæƒ…å†µå¤„ç†
1. éœ€è¦æ„é€ ä¸€ä¸ªæ•°ç»„ **sourceï¼š**
    * å­˜å‚¨çš„æ˜¯**æ–°å­èŠ‚ç‚¹ï¼ˆç”¨keyè¡¨ç¤ºä¸€ä¸ªèŠ‚ç‚¹ï¼‰åœ¨â€œæ—§çš„ä¸€ç»„å­èŠ‚ç‚¹â€ä¸­çš„ä½ç½®ç´¢å¼•**ã€‚åé¢**å°†ä¼šä½¿ç”¨å®ƒè®¡ç®—å‡ºä¸€ä¸ªæœ€é•¿é€’å¢å­åºåˆ—ï¼Œå¹¶ç”¨äºè¾…åŠ©å®Œæˆ DOM ç§»åŠ¨çš„æ“ä½œ**ã€‚  
    * å®ƒçš„**é•¿åº¦**ç­‰äºæ–°çš„ä¸€ç»„å­èŠ‚ç‚¹åœ¨**ç»è¿‡é¢„å¤„ç†ä¹‹åå‰©ä½™æœªå¤„ç†èŠ‚ç‚¹çš„æ•°é‡**ï¼Œå¹¶ä¸” source ä¸­æ¯ä¸ªå…ƒç´ çš„**åˆå§‹å€¼éƒ½æ˜¯ -1**
    * ç”±äºæ•°ç»„ source çš„ç´¢å¼•æ˜¯ä» 0 å¼€å§‹çš„ï¼Œè€Œæœªå¤„ç†èŠ‚ç‚¹çš„ç´¢å¼•æœªå¿…ä» 0 å¼€å§‹ï¼Œæ‰€ä»¥åœ¨å¡«å……æ•°ç»„æ—¶éœ€è¦ä½¿ç”¨è¡¨è¾¾å¼ k - newStart çš„å€¼ä½œä¸ºæ•°ç»„çš„ç´¢å¼•å€¼

2. ä¸ºäº†å¿«é€Ÿå¡«å…… source æ•°ç»„ï¼Œéœ€è¦ä¸º**æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹æ„å»ºä¸€å¼ ç´¢å¼•è¡¨*KeyIndex*ï¼Œç”¨æ¥å­˜å‚¨èŠ‚ç‚¹çš„ key å’ŒèŠ‚ç‚¹ä½ç½®ç´¢å¼•ä¹‹é—´çš„æ˜ å°„**
```js
const keyIndex = {}
for(let i = newStart; i <= newEnd; i++) {
  keyIndex[newChildren[i].key] = i
}
```

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
```js
if (j > oldEnd && j <= newEnd) {
  // çœç•¥éƒ¨åˆ†ä»£ç 
} else if (j > newEnd && j <= oldEnd) {
  // çœç•¥éƒ¨åˆ†ä»£ç 
} else {
  const count = newEnd - j + 1
  const source = new Array(count)
  source.fill(-1)
  
  // oldStart å’Œ newStart åˆ†åˆ«ä¸ºèµ·å§‹ç´¢å¼•ï¼Œå³ j
  const oldStart = j
  const newStart = j

  // æ„å»ºç´¢å¼•è¡¨
  const keyIndex = {}
  for(let i = newStart; i <= newEnd; i++) {
    keyIndex[newChildren[i].key] = i
  }

  // éå†æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­å‰©ä½™æœªå¤„ç†çš„èŠ‚ç‚¹
  for(let i = oldStart; i <= oldEnd; i++) {
    oldVNode = oldChildren[i]
    // é€šè¿‡ç´¢å¼•è¡¨å¿«é€Ÿæ‰¾åˆ°æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­å…·æœ‰ç›¸åŒ key å€¼çš„èŠ‚ç‚¹ä½ç½®
    const k = keyIndex[oldVNode.key]
    if (typeof k !== 'undefined') {
      newVNode = newChildren[k]
      // è°ƒç”¨ patch å‡½æ•°å®Œæˆæ›´æ–°
      patch(oldVNode, newVNode, container)
      // å¡«å…… source æ•°ç»„
      source[k - newStart] = i
    } else {
      // æ²¡æ‰¾åˆ°
      unmount(oldVNode)
    }
  }
}
```
ç¬¬äºŒä¸ª for å¾ªç¯ç”¨æ¥éå†æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬**æ‹¿æ—§å­èŠ‚ç‚¹çš„ key å€¼å»ç´¢å¼•è¡¨ keyIndexä¸­æŸ¥æ‰¾è¯¥èŠ‚ç‚¹åœ¨æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­çš„ä½ç½®**ï¼Œå¹¶å°†æŸ¥æ‰¾ç»“æœå­˜å‚¨åˆ°å˜é‡ k ä¸­ã€‚å¦‚æœ k å­˜åœ¨ï¼Œè¯´æ˜è¯¥èŠ‚ç‚¹æ˜¯å¯å¤ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è°ƒç”¨ patch å‡½æ•°è¿›è¡Œæ‰“è¡¥ä¸ï¼Œå¹¶å¡«å……source æ•°ç»„ï¼›å¦åˆ™è¯´æ˜è¯¥èŠ‚ç‚¹å·²ç»ä¸å­˜åœ¨äºæ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­äº†ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦è°ƒç”¨ unmount å‡½æ•°å¸è½½å®ƒã€‚

### åˆ¤æ–­æ˜¯å¦è¦ç§»åŠ¨ï¼Ÿ
å¿«é€Ÿ Diff ç®—æ³•åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨çš„æ–¹æ³•ä¸*ç®€å•Diff ç®—æ³•*ç±»ä¼¼ï¼Œå¦‚æœåœ¨éå†è¿‡ç¨‹ä¸­é‡åˆ°çš„**ç´¢å¼•å€¼å‘ˆç°é€’å¢è¶‹åŠ¿ï¼Œåˆ™è¯´æ˜ä¸éœ€è¦ç§»åŠ¨èŠ‚ç‚¹**ï¼Œåä¹‹åˆ™éœ€è¦ã€‚ï¼ˆæ³¨æ„ï¼Œè¿™é‡Œæ˜¯æ–°èŠ‚ç‚¹çš„ç´¢å¼•å€¼ï¼‰

å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼š
```js
// æ–°å¢ä¸¤ä¸ªå˜é‡ï¼Œmoved å’Œ pos
let moved = false  // æ˜¯å¦è¦ç§»åŠ¨ï¼Ÿ
let pos = 0   // éå†æ—§çš„ä¸€ç»„å­èŠ‚ç‚¹çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„æœ€å¤§ç´¢å¼•å€¼ k

// åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦éœ€è¦ç§»åŠ¨, å…¶ä¸­kæ˜¯oldChildrençš„éå†ä¸­è·å–ï¼Œä¸”æ–°ã€æ—§èŠ‚ç‚¹åŒæ—¶å‡ºç°çš„key; å…·ä½“å‚çœ‹ä¸‹é¢çš„ä»£ç 
if (k < pos) {    // posæ˜¯æœ€å¤§å€¼ï¼Œè‹¥åœ¨éå†è¿‡ç¨‹ä¸­é‡åˆ°æ¯”ä»–å°çš„åˆ™ç§»åŠ¨
    moved = true
} else {
    pos = k
}  
```

æˆ‘ä»¬è¿˜éœ€è¦ä¸€**ä¸ªæ•°é‡æ ‡è¯†ï¼Œä»£è¡¨å·²ç»æ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡ patched**ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ**å·²ç»æ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡åº”è¯¥å°äºæ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡**ã€‚ä¸€æ—¦å‰è€…è¶…è¿‡åè€…ï¼Œåˆ™è¯´æ˜æœ‰å¤šä½™çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥å°†å®ƒä»¬å¸è½½ã€‚
```js
// count: æ€»çš„è¦ç§»åŠ¨çš„èŠ‚ç‚¹æ•°
const count = newEnd - j +1
```

æœ¬ç« èŠ‚æ€»çš„ä»£ç å¦‚ä¸‹ï¼š
```js
if (j > oldEnd && j <= newEnd) {
  // çœç•¥éƒ¨åˆ†ä»£ç 
} else if (j > newEnd && j <= oldEnd) {
  // çœç•¥éƒ¨åˆ†ä»£ç 
} else {
  // æ„é€  source æ•°ç»„
  const count = newEnd - j + 1
  const source = new Array(count)
  source.fill(-1)
  const oldStart = j
  const newStart = j
  let moved = false
  let pos = 0
  const keyIndex = {}
  for(let i = newStart; i <= newEnd; i++) {
    keyIndex[newChildren[i].key] = i
  }
  // æ–°å¢ patched å˜é‡ï¼Œä»£è¡¨æ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡
  let patched = 0
  for(let i = oldStart; i <= oldEnd; i++) {
    oldVNode = oldChildren[i]
    // å¦‚æœæ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡å°äºç­‰äºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ï¼Œåˆ™æ‰§è¡Œæ›´æ–°
    if (patched <= count) {
      const k = keyIndex[oldVNode.key]
      if (typeof k !== 'undefined') {
        newVNode = newChildren[k]
        patch(oldVNode, newVNode, container)
        // æ¯æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å°† patched å˜é‡ +1
        patched++
        source[k - newStart] = i
        if (k < pos) {
          moved = true
        } else {
          pos = k
        }
      } else {
        // æ²¡æ‰¾åˆ°
        unmount(oldVNode)
      }
    } else {
      // å¦‚æœæ›´æ–°è¿‡çš„èŠ‚ç‚¹æ•°é‡å¤§äºéœ€è¦æ›´æ–°çš„èŠ‚ç‚¹æ•°é‡ï¼Œåˆ™å¸è½½å¤šä½™çš„èŠ‚ç‚¹
      unmount(oldVNode)
    }
  }
}
```
## ä¸‰ã€å¦‚ä½•ç§»åŠ¨
moved è‹¥ä¸º trueï¼Œè¯´æ˜éœ€è¦è¿›è¡ŒDOM ç§»åŠ¨æ“ä½œã€‚
```js
if (j > oldEnd && j <= newEnd) {
  // çœç•¥éƒ¨åˆ†ä»£ç 
} else if (j > newEnd && j <= oldEnd) {
  // çœç•¥éƒ¨åˆ†ä»£ç 
} else {
  // çœç•¥éƒ¨åˆ†ä»£ç 
  for(let i = oldStart; i <= oldEnd; i++) {
    // çœç•¥éƒ¨åˆ†ä»£ç 
  }
  if (moved) {
    // å¦‚æœ moved ä¸ºçœŸï¼Œåˆ™éœ€è¦è¿›è¡Œ DOM ç§»åŠ¨æ“ä½œ
  }
}
```
å¦‚ä½•æ±‚è§£source æ•°ç»„çš„æœ€é•¿é€’å¢å­åºåˆ—ï¼Ÿ
```js
if (moved) {
  // è®¡ç®—æœ€é•¿é€’å¢å­åºåˆ—
  const seq = lis(sources) // [ 0, 1 ]
}
```
æ³¨æ„ğŸ“¢ï¼š lis å‡½æ•°çš„è¿”å›ç»“æœæ˜¯æœ€é•¿é€’å¢å­åºåˆ—ä¸­çš„å…ƒç´ åœ¨source æ•°ç»„ä¸­çš„ä½ç½®ç´¢å¼•ã€‚

åœ¨ç¼–å·æ—¶ï¼Œæˆ‘ä»¬å¿½ç•¥äº†ç»è¿‡é¢„å¤„ç†çš„èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œéœ€è¦é‡æ–°ç¼–å·ã€‚é‡æ–°ç¼–å·çš„å«ä¹‰æ˜¯ï¼šåœ¨æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­ï¼Œé‡æ–°ç¼–å·åç´¢å¼•å€¼ä¸º 0 å’Œ 1 çš„è¿™ä¸¤ä¸ªèŠ‚ç‚¹åœ¨æ›´æ–°å‰åé¡ºåºæ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚

ä¸ºäº†å®ŒæˆèŠ‚ç‚¹çš„ç§»åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸¤ä¸ªç´¢å¼•å€¼ i å’Œsï¼š
* ç”¨ç´¢å¼• i æŒ‡å‘æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ newChild ä¸­çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼›  
* ç”¨ç´¢å¼• s æŒ‡å‘æœ€é•¿é€’å¢å­åºåˆ— seq ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚

ç”±äºç´¢å¼• i æ˜¯é‡æ–°ç¼–å·åçš„ï¼Œå› æ­¤ä¸ºäº†å¾—åˆ°çœŸå®ç´¢å¼•å€¼ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—è¡¨è¾¾å¼ i + newStart çš„å€¼ã€‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š
```js
if (moved) {
  const seq = lis(sources)
  // s æŒ‡å‘æœ€é•¿é€’å¢å­åºåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ 
  let s = seq.length - 1
  let i = count - 1 // countæ˜¯sourceæ•°ç»„çš„é•¿åº¦
  for (i; i >= 0; i--) {
    if (source[i] === -1) {
     // è¯´æ˜ç´¢å¼•ä¸º i çš„èŠ‚ç‚¹æ˜¯å…¨æ–°çš„èŠ‚ç‚¹ï¼Œåº”è¯¥å°†å…¶æŒ‚è½½
      // è¯¥èŠ‚ç‚¹åœ¨æ–° children ä¸­çš„çœŸå®ä½ç½®ç´¢å¼•
      const pos = i + newStart
      const newVNode = newChildren[pos]
      // è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ç´¢å¼•
      const nextPos = pos + 1
      // é”šç‚¹
      const anchor = nextPos < newChildren.length
        ? newChildren[nextPos].el
        : null
      // æŒ‚è½½
      patch(null, newVNode, container, anchor)
    } 
    
    else if (i !== seq[s]) {
      // è¯´æ˜è¯¥èŠ‚ç‚¹éœ€è¦ç§»åŠ¨
      // è¯¥èŠ‚ç‚¹åœ¨æ–°çš„ä¸€ç»„å­èŠ‚ç‚¹ä¸­çš„çœŸå®ä½ç½®ç´¢å¼•
      const pos = i + newStart
      const newVNode = newChildren[pos]
      // è¯¥èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ç´¢å¼•
      const nextPos = pos + 1
      // é”šç‚¹
      const anchor = nextPos < newChildren.length
        ? newChildren[nextPos].el
        : null
      // ç§»åŠ¨
      insert(newVNode.el, container, anchor)
    } 
    
    else {
      // å½“ i === seq[s] æ—¶ï¼Œè¯´æ˜è¯¥ä½ç½®çš„èŠ‚ç‚¹ä¸éœ€è¦ç§»åŠ¨
      // å¹¶è®© s æŒ‡å‘ä¸‹ä¸€ä¸ªä½ç½®
      s--
    }
  }
}
```